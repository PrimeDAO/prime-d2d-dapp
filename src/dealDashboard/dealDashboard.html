<template>
  <require from="../funding/swap-status/swap-status"></require>
  <require from="./dealMenubar/dealMenubar"></require>
  <require from="./dealVotes/dealVotes"></require>
  <require from="./dealInfo/dealInfo"></require>
  <require from="./dealClauses/dealClauses"></require>
  <require from="./dealDiscussion/dealDiscussion"></require>
  <require from="./dealMakeAnOffer/dealMakeAnOffer"></require>
  <require from="./dealDescription/dealDescription"></require>
  <require from="./status-action-bar/status-action-bar"></require>
  <require from="../deals/timeLeft/timeLeft"></require>

  <main
    data-test="deal-dashboard-container"
    class="page animated-page au-animate dealDashboardContainer"
  >
    <deal-menubar deal.bind="deal"></deal-menubar>

    <section class="section top">
      <h1 data-test="dealTitle" class="title heading heading1 gradient">
        ${deal.registrationData.proposal.title}
      </h1>

      <let deal-privacy-text="${deal.isPrivate ? 'Private' : 'Public'}"></let>
      <h2 data-test="dealStatus">
        <time-left deal.to-view="deal" hide-icons largest>
          <span slot="before">â€¢</span>
          <span>(${dealPrivacyText})</span>
        </time-left>
      </h2>
    </section>

    <aside class="aside">
      <deal-votes deal.bind="deal" if.bind="!deal.isOpenProposal"></deal-votes>
      <deal-info deal.bind="deal"></deal-info>
      <deal-make-an-offer
        deal.bind="deal"
        if.bind="deal.isOpenProposal && !deal.isUserProposalLead"
      ></deal-make-an-offer>
    </aside>

    <deal-description deal.bind="deal"></deal-description>

    <deal-clauses
      authorized.bind="isAllowedToDiscuss"
      deal.bind="deal"
      discussion-id.two-way="discussionId"
      if.to-view="deal.isUserRepresentativeOrLead || !deal.isPrivate"
    ></deal-clauses>
    <swap-status deal.bind="deal" if.to-view="deal.primaryDao.tokens && deal.partnerDao">
      <!-- Show this only when the deal is fully funded but before the swap has been executed -->
      <status-action-bar
        if.to-view="deal.isTargetReached && deal.isFunding"
        content="IMPORTANT: Funding is complete so you must initiate swapping before the funding period expires in XXXX days."
      >
        <pbutton type="primary" click.delegate="executeSwap()" disabled.bind="isExecutingSwap">
          Execute Swap <i class="fas">&#xf021;</i>
        </pbutton>
      </status-action-bar>
      <!-- Show this only when the swap has been executed and the user is either the proposal lead or a representative -->
      <status-action-bar
        if.to-view="deal.isClaiming && !deal.isFullyClaimed && deal.isUserRepresentativeOrLead"
        content="${deal.isRepresentativeUser ? 'IMPORTANT: Go to Claiming to claim vested tokens for your DAO.' : null}"
      >
        <pbutton type="primary" click.delegate="router.navigate(`funding/${deal.id}`)">
          ${deal.isRepresentativeUser ? 'Go to Claiming' : 'Go to Status'}
          <i class="fas fa-arrow-right"></i>
        </pbutton>
      </status-action-bar>
      <status-action-bar
        if.to-view="deal.isClaiming && deal.isFullyClaimed && deal.isUserRepresentativeOrLead"
        content="All the swaps have been completed.  Go To Deal Status to see the final state of the deal."
        icon-class="check-circle"
        icon-color="success"
      >
        <pbutton type="primary" click.delegate="router.navigate(`funding/${deal.id}`)">
          Go To Deal Status
          <i class="fas fa-arrow-right"></i>
        </pbutton>
      </status-action-bar>
      <status-action-bar
        if.to-view="deal.isFailed && deal.isUserRepresentativeOrLead"
        content="${deal.isRepresentativeUser ? 'IMPORTANT: You can withdraw your tokens at any time as this deal has failed.  Go To Withdraw to withdraw token deposits.' : null}"
      >
        <pbutton type="primary" click.delegate="router.navigate(`funding/${deal.id}`)">
          ${deal.isRepresentativeUser ? 'Go To Withdraw' : 'Go to Status'}
          <i class="fas fa-arrow-right"></i>
        </pbutton>
      </status-action-bar>
    </swap-status>
    <!-- Discussions / Discussion Comments Thread -->
    <deal-discussion
      authorized.bind="isAllowedToDiscuss"
      deal.bind="deal"
      discussion-id.two-way="discussionId"
      show.bind="deal.isUserRepresentativeOrLead || !deal.isPrivate"
    ></deal-discussion>
  </main>
</template>
