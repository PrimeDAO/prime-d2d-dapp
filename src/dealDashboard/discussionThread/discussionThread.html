<template>
  <require from="./singleComment/singleComment"></require>
  <section class="thread" ref="refThread">
    <section class="head container">
      <div class="header">
        <h1 class="subtitle heading heading1 gradient">
          Discuss
        </h1>
        <pbutton type="secondary" click.delegate="navigateTo('')">Back To List</pbutton>
      </div>
    </section>
    <hgroup class="title" ref="refTitle">
      <h2 class="heading topic ${atTop? 'at-top': ''}">${dealDiscussion.topic}</h2>
      <span if.bind="dealDiscussion && dealDiscussion.createdBy.address">
        <h3 class="subtext">Clause #${dealDiscussion.clauseIndex + 1}</h3>
        <h3 class="subtext">
          <span if.bind="dealDiscussion.createdByName">
            Created by ${dealDiscussion.createdByName}
          </span>
          <span else>
            Created by ${dealDiscussion.createdByAddress | smallHexString}
          </span>
          at ${ dateService.formattedTime(dealDiscussion.createdAt).short() }</h3>
      </span>
    </hgroup>
    <div class="sticky-area">
      <section class="comments container">
        <div if.bind="isLoading.discussions" class="comment isLoading">
          <i class="spinner fa fas fa-circle-notch fa-spin"></i>
          Loading comments...
        </div>

        <div if.bind="!threadComments.length && isMember && !isLoading.discussions" class="no comment">
          This discussion has no comments yet.
        </div>

        <div if.bind="!threadComments.length && !isMember && !isLoading.discussions" class="no comment">
          This discussion is private.
        </div>

        <div 
          if.bind="!isLoading.discussions && threadComments.length"
          repeat.for="comment of threadComments"
          id="${comment._id}"
          class="comment">
          <single-comment
            callback.call="doAction(action, args)"
            discussionId.bind="discussionId"
            author.bind="dealDiscussion.createdBy.address"
            profile.bind="threadProfiles[comment.author]"
            loading.bind="isLoading"
            highlighted.bind="isReply && comment._id === replyToOriginalMessage._id"
            index="${$index}"
            replies-to.bind="comment.replyTo ? (threadDictionary[comment.replyTo] ? threadDictionary[comment.replyTo] : deletedComment) : ''"
            replies-to-profile.bind="comment.replyTo ? (threadProfiles[threadDictionary[comment.replyTo].author]) : ''"
            comment.bind="comment">
          </single-comment>
        </div>
      </section>
      <!-- <pbutton class="load-more" type="tertiary" if.bind="comments.length < threadComments.length" click.delegate="loadMoreComments()">Load More</pbutton> -->

      <!-- Comment Input -->
      <section if.bind="isAuthorized && isMember" class="action container">
        <div if.bind="isReply" class="replyState">
          <p class="action heading heading3">
            <i class="fas fa-share"></i>
            <span if.bind="replyToOriginalMessage && replyToOriginalMessage.authorName">
              Reply to ${replyToOriginalMessage.authorName}
            </span>
            <span else if.bind="replyToOriginalMessage && replyToOriginalMessage.author">
              Reply to ${replyToOriginalMessage.author | smallHexString}
            </span>
            <button click.delegate="closeReply()">
              <i class="fas fa-times"></i>
            </button>
          </p>
          <p class="subtitle">${replyToOriginalMessage.text}</p>
        </div>
        <div else>
          <p class="action heading heading3">
            <span>Comment</span>
          </p>
        </div>
        <ptextarea
          ref="refCommentInput"
          placeholder="${isReply? 'Type your reply here...' : 'Type your comment here...'}"
          value.two-way="comment"
          rows="2"
          validation-state="${isLoading.commenting ? 'validating' : ''}"
          disabled.bind="isLoading.commenting"
          class="comment-input">
        </ptextarea>
        <pbutton
          class="action do"
          type="primary"
          full-width
          disabled.bind="isLoading.commenting || !comment.length"
          loading.bind="isLoading.commenting"
          click.delegate="addComment()">
          ${isReply ? "Reply" : "Comment"}
        </pbutton>
      </section>
      <span ref="refThreadEnd"></span>
    </div>
  </section>
</template>