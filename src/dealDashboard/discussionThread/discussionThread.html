<template>
  <require from="./singleComment/singleComment"></require>
  <section class="thread">
    <section class="head container">
      <div class="header">
        <h1 class="subtitle heading heading1 gradient">
          Discuss
        </h1>
        <pbutton type="secondary" click.delegate="navigateTo('')">Back To List</pbutton>
      </div>
      <hgroup class="title">
        <h2 class="heading topic">${dealDiscussion.topic}</h2>
        <span if.bind="dealDiscussion && dealDiscussion.createdByAddress">
          <h3 class="subtext">Clause #${dealDiscussion.clauseId + 1}</h3>
          <h3 class="subtext">
            Created by ${dealDiscussion.createdByAddress | smallHexString}
            at ${ dateService.formattedTime(dealDiscussion.createdAt).short() }</h3>
        </span>
      </hgroup>
    </section>
    <div class="sticky-area">
      <section class="comments container">
        <div if.bind="isLoading === 'isFetching'" class="comment isLoading">
          <i class="spinner fa fas fa-circle-notch fa-spin"></i>
          Loading comments...
        </div>
        <div if.bind="!threadComments.length && isLoading !== 'isFetching'" class="no comment">
          This discussion has no comments yet.
        </div>
        <div 
          if.bind="isLoading !== 'isFetching' && threadComments.length"
          repeat.for="comment of threadComments"
          id="${comment._id}"
          class="comment">
          <single-comment
            callback.call="doAction(action, args)"
            discussionId.bind="discussionId"
            author.bind="dealDiscussion.createdBy"
            loading.bind="isLoading"
            highlighted.bind="isReply && comment._id === replyToOriginalMessage._id"
            index="${$index}"
            replies-to.bind="comment.replyTo ? (threadDictionary[comment.replyTo] ? threadDictionary[comment.replyTo] : deletedComment) : ''"
            comment.bind="comment">
          </single-comment>
        </div>
      </section>
      <!-- <pbutton class="load-more" type="tertiary" if.bind="comments.length < threadComments.length" click.delegate="loadMoreComments()">Load More</pbutton> -->

      <!-- Comment Input -->
      <section if.bind="isAuthorized" class="action container">
        <div if.bind="isReply" class="replyState">
          <p class="action heading heading3">
            <i class="fas fa-share"></i>
            <span if.bind="replyToOriginalMessage && replyToOriginalMessage.authorName">
              Reply to ${replyToOriginalMessage.authorName}
            </span>
            <span else if.bind="replyToOriginalMessage && replyToOriginalMessage.author">
              Reply to ${replyToOriginalMessage.author | smallHexString}
            </span>
            <button click.delegate="closeReply()">
              <i class="fas fa-times"></i>
            </button>
          </p>
          <p class="subtitle">${replyToOriginalMessage.text}</p>
        </div>
        <div else>
          <p class="action heading heading3">
            <span>Comment</span>
          </p>
        </div>
        <ptextarea
          placeholder="${isReply? 'Type your reply here...' : 'Type your comment here...'}"
          value.two-way="comment"
          enter.delegate="addComment()"
          focus.delegate="focus()"
          blur.delegate="blur()"
          validation-state="${isLoading === 'commenting' ? 'validating' : ''}"
          disabled.bind="isLoading === 'commenting'">
          class="comment-input"></ptextarea>
        <pbutton
          class="action do"
          type="primary"
          full-width
          disabled.bind="isLoading === 'commenting'"
          click.delegate="addComment()">
          ${isReply ? "Reply" : "Comment"}
        </pbutton>
      </section>
    </div>
  </section>
</template>