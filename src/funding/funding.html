<template>
  <require from="./swap-status/swap-status"></require>
  <require from="./deposit-grid/deposit-grid"></require>
  <main class="page animated-page au-animate fundContainer">
    <section class="section top">
      <h1 class="title heading heading1 gradient">
        Swap tokenized carbon credits for a better world
      </h1>
      <pbutton type="secondary" click.delegate="goToDealPage()" rel="noopener noreferrer"
        >Return to deal page</pbutton
      >
    </section>
    <section
      class="section deposit"
      if.to-view="firstDao.tokens && firstDao.tokens.length && !deal.isClaiming"
    >
      <div class="box-container">
        <deposit-grid
          deal.bind="deal"
          dao.bind="firstDao"
          dao-tokens.bind="firstDao.tokens"
          show-chip.bind="true"
          funding-days-left="${(deal.timeLeftToExecute / (60*60*24*1000)).toFixed(0)}"
        ></deposit-grid>
        <deposit-grid
          deal.bind="deal"
          if.to-view="deal.isUserProposalLead"
          dao.bind="secondDao"
          dao-tokens.bind="secondDao.tokens"
          show-chip.bind="false"
        ></deposit-grid>
        <div class="container-footer">
          <let
            show-deposit-form.bind="deal.isRepresentativeUser && !deal.isTargetReached && !deal.isFailed"
          ></let>
          <div class="contracts">
            <p>
              <i class="fas fa-info-circle"></i>
              <span if.to-view="deal.isFailed && deal.isRepresentativeUser">
                The deal has failed as one or more parties failed to deposit their funds within the
                given period of time. Please go to the Deposits below and withdraw your funds. You
                can withdraw your funds at any time. Your funds are secured.
              </span>
              <span if.to-view="deal.isFailed && !deal.isRepresentativeUser">
                The deal has failed as one or more parties failed to deposit their funds within the
                given period of time. The representatives can withdraw their funds at any time.
                Their funds are secured.
              </span>
              <span if.to-view="showDepositForm">
                You're depositing on behalf of ${firstDao.name}. This deal needs to be funded and
                executed within ${deal.timeLeftToExecute | timespan:'largest2'}.
              </span>
              <span
                if.to-view="!deal.isFailed && !deal.isTargetReached && !deal.isRepresentativeUser"
              >
                This deal needs to be funded and executed within ${deal.timeLeftToExecute |
                timespan:'largest2'} days. Only representatives can deposit the tokens.
              </span>
              <span if.to-view="!deal.isFailed && deal.isTargetReached">
                All parties have deposited their funds. You may now execute the deal.
              </span>
            </p>
          </div>
          <div class="deposit" if.to-view="showDepositForm">
            <div class="form">
              <div>
                <div class="inputs">
                  <pselect
                    disabled.bind="firstDao.tokens.length === 1"
                    placeholder="Select a Token"
                    data.bind="tokenSelectData"
                    value.bind="selectedToken"
                  ></pselect>
                  <numeric-input
                    css="pInput"
                    value.bind="depositAmount"
                    keyup.delegate="checkMaxAmount()"
                    decimals.bind="firstDao.tokens[selectedToken].decimals"
                  >
                  </numeric-input>
                  <pbutton type="secondary" click.delegate="setMax()" disabled.bind="!selectedToken"
                    >Max</pbutton
                  >
                  <span class="balance" if.to-view="accountBalance">
                    Your ${firstDao.tokens[selectedToken].symbol} Balance:
                    <tokenbalance
                      formatted="0.00a"
                      token-address.bind="firstDao.tokens[selectedToken].address"
                    ></tokenbalance>
                  </span>
                </div>
              </div>
              <pbutton
                if.to-view="lockRequired"
                type="primary"
                click.delegate="unlockTokens()"
                disabled.bind="!selectedToken || !depositAmount || depositAmount <= 0"
                >Unlock</pbutton
              >
              <pbutton
                else
                type="primary"
                click.delegate="depositTokens()"
                disabled.bind="!selectedToken || !depositAmount || depositAmount <= 0"
                >Deposit</pbutton
              >
            </div>
          </div>
          <div class="links ${!deal.isRepresentativeUser ? 'right' : ''}">
            <address-link
              address.to-view="deal.daoDepositContracts.get(firstDao).address"
              link-text="DAODepositManager Contract"
              show-arrow-inside-link.bind="true"
              show-copy-icon.bind="false"
            >
            </address-link>
            <address-link
              address.to-view="deal.moduleContract.address"
              link-text="TokenSwapModule Contract"
              show-arrow-inside-link.bind="true"
              show-copy-icon.bind="false"
            >
            </address-link>
          </div>
        </div>
      </div>
    </section>
    <swap-status deal.bind="deal">
      <div class="claim-tokens" if.to-view="deal.isClaiming">
        <div class="box-container">
          <div>
            <div class="token-grid">
              <h4 class="title heading heading3 gradient">${firstDao.name}</h4>
              <pgrid
                id="token-grid"
                rows.bind="firstDao.tokens"
                columns.bind="claimTokenGridColumns"
                condensed.bind="true"
              >
              </pgrid>
            </div>
            <div class="token-grid" if.to-view="deal.isUserProposalLead">
              <h4 class="title heading heading3 gradient">${secondDao.name}</h4>
              <pgrid
                id="token-grid"
                rows.bind="secondDao.tokens"
                columns.bind="claimTokenGridColumns"
                condensed.bind="true"
              >
              </pgrid>
            </div>
          </div>
          <div class="contract">
            <p>
              <i class="fas fa-info-circle"></i>
              <span>
                ${deal.isRepresentativeUser ? 'Your' : 'Representatitves of each'} DAO will be able
                to claim vested tokens once they are claimable.
              </span>
            </p>
            <div>
              <address-link
                address.to-view="deal.daoDepositContracts.get(firstDao).address"
                link-text="DAODepositManager Contract"
                show-arrow-inside-link.bind="true"
                show-copy-icon.bind="false"
              >
              </address-link>
              <address-link
                address.to-view="deal.moduleContract.address"
                link-text="TokenSwapModule Contract"
                show-arrow-inside-link.bind="true"
                show-copy-icon.bind="false"
              >
              </address-link>
            </div>
            <h4
              class="claim-tokens-header title heading gradient"
              if.to-view="deal.isRepresentativeUser && deal.isUserProposalLead"
            >
              Claim Tokens for ${firstDao.name}
            </h4>
            <pbutton
              type="primary"
              if.to-view="deal.isRepresentativeUser"
              click.delegate="claimTokens()"
              >Claim Tokens</pbutton
            >
          </div>
        </div>
      </div>
    </swap-status>
    <section class="section deposits">
      <h1 class="title heading heading1 gradient">Deposits</h1>
      <div class="no-deposits heading02" if.to-view="!deposits || deposits.length === 0">
        There are no deposits for this deal
      </div>
      <pgrid
        id="deposits-grid"
        rows.bind="deposits"
        columns.bind="depositColumns"
        condensed.bind="false"
        sort-column="createdAt"
        sort-direction.bind="-1"
        if.to-view="deposits.length > 0"
      ></pgrid>
    </section>
  </main>
</template>
