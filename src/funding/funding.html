<template>
  <require from="../deals/dao-icon-name/dao-icon-name"></require>
  <require from="../resources/elements/chip/chip"></require>
  <require from="./status-card/status-card"></require>
  <main class="page animated-page au-animate fundContainer">
    <section class="section top">
      <h1 class="title heading heading1 gradient">
        Swap tokenized carbon credits for a better world
      </h1>
      <pbutton type="secondary" click.delegate="goToDealPage()" rel="noopener noreferrer"
        >Return to deal page</pbutton
      >
    </section>
    <section
      class="section deposit"
      if.to-view="daoRelatedToWallet.tokens && daoRelatedToWallet.tokens.length && !swapCompleted"
    >
      <div class="box-container">
        <div class="box-header">
          <div class="heading heading3 title gradient">${daoRelatedToWallet.name} Deposit</div>
          <chip
            color="${fundingDaysLeft >= 10 ? 'warning' : 'danger'}"
            if.to-view="fundingDaysLeft >= 0"
          >
            <span class="icon far fa-clock" slot="icon"></span>${fundingDaysLeft} days left
          </chip>
          <chip color="danger" if.to-view="fundingFailed">Target not reached</chip>
        </div>
        <div class="box-content">
          <div class="tokens">
            <div class="grid tokenGrid">
              <div class="row header">
                <div class="cell token header">Token</div>
                <div class="cell target header">Target</div>
                <div class="cell deposited header">Deposited</div>
                <div class="cell required header">Required</div>
                <div class="cell completed header">Completed</div>
                <div class="cell percent header">%</div>
              </div>
              <template repeat.for="token of daoRelatedToWallet.tokens | sort:sortEvaluator">
                <div class="row body">
                  <div class="token cell body">
                    <dao-icon-name
                      primary-dao.to-view="token"
                      icon-size="24"
                      use-token-symbol.to-view="true"
                    ></dao-icon-name>
                  </div>
                  <div class="target cell body">${token.target | ethwei:token.decimals}</div>
                  <div class="deposited cell body">${token.deposited | ethwei:token.decimals}</div>
                  <div class="required cell body">${token.required | ethwei:token.decimals}</div>
                  <div class="completed cell body">
                    <progress-bar
                      style="height: 10px; width: 100%"
                      max.bind="token.target"
                      current.bind="token.deposited"
                    ></progress-bar>
                  </div>
                  <div class="percent cell body">${token.percentCompleted}%</div>
                </div>
              </template>
            </div>
          </div>
        </div>
        <div class="container-footer">
          <div class="contracts">
            <p>
              <i class="fas fa-info-circle"></i>
              <span if.to-view="fundingFailed">
                The deal has failed as one or more parties failed to deposit their funds within the
                given period of time. Please go to the Transactions below and withdraw your funds.
                You can withdraw your funds at any time. Funds are safe.
              </span>
              <span if.to-view="!fundingFailed && !dealTargetReached">
                You're depositing on behalf of ${daoRelatedToWallet.name}. This deal needs to be
                funded and executed within ${fundingDaysLeft} days.
              </span>
              <span if.to-view="!fundingFailed && dealTargetReached">
                All parties have deposited their funds. Anyone can now initiate the swap.
              </span>
            </p>
            <div>
              <a href="${tokenDepositContractUrl}" target="_blank" rel="noopener noreferrer"
                >DepositContract Contract <i class="fas fa-arrow-right"></i
              ></a>
              <a href="${tokenSwapModuleContractUrl}" target="_blank" rel="noopener noreferrer"
                >TokenSwapModule Contract <i class="fas fa-arrow-right"></i
              ></a>
            </div>
          </div>
          <div class="deposit">
            <div class="form" if.to-view="!isProposalLead && !dealTargetReached && !fundingFailed">
              <div>
                <div class="inputs">
                  <pselect
                    disabled.bind="daoRelatedToWallet.tokens.length === 1"
                    placeholder="Select a Token"
                    data.bind="tokenSelectData"
                    value.bind="selectedToken"
                    ref="refSelectToken"
                  ></pselect>
                  <numeric-input
                    css="pInput"
                    value.bind="depositAmount"
                    keyup.delegate="checkMaxAmount()"
                  >
                  </numeric-input>
                  <pbutton type="secondary" click.delegate="setMax()" disabled.bind="!selectedToken"
                    >Max</pbutton
                  >
                  <span class="balance" if.to-view="walletBalance">
                    Your ${daoRelatedToWallet.tokens[selectedToken].symbol} Balance:
                    <formatted-number
                      value="${walletBalance | ethwei:token.decimals}"
                      mantissa="2"
                    ></formatted-number>
                  </span>
                </div>
              </div>
              <pbutton
                type="primary"
                click.delegate="depositTokens()"
                disabled.bind="!selectToken && !depositAmount"
                >Deposit</pbutton
              >
            </div>
          </div>
        </div>
      </div>
    </section>
    <section class="section swap-status">
      <div class="heading heading3 title gradient">Token Swap Status</div>
      <div class="status-cards">
        <status-card
          dao.bind="daoRelatedToWallet"
          swap-completed.bind="swapCompleted"
          funding-failed.bind="fundingFailed"
        ></status-card>
        <div class="swap ${swapCompleted || fundingFailed ? 'complete' : ''}">
          <i class="fas fa-arrow-right"></i>
          <i if.to-view="swapCompleted" class="fas fa-check-circle success center"></i>
          <i if.to-view="fundingFailed" class="fas fa-times-circle danger center"></i>
          <i class="fas fa-arrow-left"></i>
        </div>
        <status-card
          dao.bind="otherDao"
          swap-completed.bind="swapCompleted"
          funding-failed.bind="fundingFailed"
        ></status-card>
      </div>
      <div class="section initiate-swap" if.to-view="dealTargetReached">
        <pbutton type="primary" click.delegate="initiateSwap()">
          Initiate swap <i class="fas">&#xf021;</i>
        </pbutton>
      </div>
    </section>
    <section class="section transactions">
      <h1 class="title heading heading1 gradient">Transactions</h1>
      <div
        class="no-transactions heading02"
        if.to-view="!transactions || transactions.length === 0"
      >
        There are no transactions for this deal
      </div>
      <div class="grid transactions-grid" if.to-view="transactions && transactions.length > 0">
        <div class="row header">
          <div class="cell dao header">DAO</div>
          <div class="cell type header">TYPE</div>
          <div class="cell amount header">AMOUNT</div>
          <div class="cell address header">ADDRESS</div>
          <div class="cell age header">AGE</div>
          <div class="cell txid header">TxID</div>
          <div class="cell withdraw header"></div>
        </div>
        <template repeat.for="transaction of transactions | sort:sortEvaluator">
          <div class="row body" if.to-view="!loadingTransactions && (($index < 10) || seeingMore)">
            <div class="dao cell body">
              <dao-icon-name primary-dao.to-view="transaction.dao"></dao-icon-name>
            </div>
            <div class="type cell body">
              <i class="fas fa-arrow-${getTypeIcon(transaction.type)}"></i> ${transaction.type}
            </div>
            <div class="amount cell body">
              <div ptooltip.to-view="transaction.token.amount">
                <img src="${transaction.token.logoURI}" />
                <span
                  >${withCommas(transaction.token.amount)}${" "}${transaction.token.symbol}</span
                >
              </div>
            </div>
            <div class="address cell body">
              <div>
                <!-- <div class="transactionType">${transaction.type === "deposit" ? "FROM" : "TO"}</div> -->
                <div class="addressLink">
                  <span ptooltip.to-view="transaction.address"
                    >${transaction.address | smallHexString}</span
                  >
                  <div class="buttons">
                    <copy-to-clipboard-button
                      text-to-copy.to-view="transaction.address"
                    ></copy-to-clipboard-button>
                    <!-- same as externalLinkIcon.svg -->
                    <svg
                      class="etherscan-button"
                      ptooltip="Inspect on Etherscan"
                      click.delegate="gotoEtherscan(transaction.address)"
                      width="17"
                      height="17"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                    >
                      <path
                        d="M19 19H5V5H12V3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V12H19V19ZM14 3V5H17.59L7.76 14.83L9.17 16.24L19 6.41V10H21V3H14Z"
                        fill="#F9F6F9"
                      />
                    </svg>
                  </div>
                </div>
              </div>
            </div>
            <div class="age cell body">${getFormattedTime(transaction.createdAt)}</div>
            <div class="txid cell body">
              <a
                click.delegate="gotoEtherscan(transaction.txid,true)"
                ptooltip="Inspect on Etherscan"
                >View
                <svg
                  class="etherscan-button"
                  width="17"
                  height="17"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                >
                  <path
                    d="M19 19H5V5H12V3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V12H19V19ZM14 3V5H17.59L7.76 14.83L9.17 16.24L19 6.41V10H21V3H14Z"
                    fill="#F9F6F9"
                  /></svg
              ></a>
            </div>
            <div class="withdraw cell body">
              <pbutton
                if.to-view="ethereumService.defaultAccountAddress === transaction.address && transaction.type === 'deposit'"
                type="secondary"
                click.delegate="withdraw(transaction)"
                >WITHDRAW</pbutton
              >
            </div>
          </div>
        </template>
      </div>
      <template if.to-view="transactions.length > 10">
        <div if.to-view="!loadingTransactions && !seeingMore" class="seeMore">
          <div class="arrow">&darr;</div>
          <div class="text" click.delegate="seeMore(true)">SEE ALL</div>
        </div>
        <div if.to-view="!loadingTransactions && seeingMore" class="seeMore">
          <div class="arrow">&uarr;</div>
          <div class="text" click.delegate="seeMore(false)">SEE A FEW</div>
        </div>
      </template>
    </section>
  </main>
</template>
