<template>
  <pcard>
    <div if.bind="viewMode === 'edit'">

      <pform-input
        data-test="proposal-token-address-field"
        helper-message.bind="tokenInfoLoading ? 'Searching token address details...': ''"
        input-reference.bind="addressInput"
        label="Token Address"
        label-info="Make sure to use the native contract address of the token.">
        <pinput-text
          input.trigger="getTokenInfo(token.address)"
          placeholder="0x..."
          validation-state.bind="tokenInfoLoading? 'validating': addressInput.validationState !== 'validating' ? addressInput.validationState : undefined"
          value.bind="token.address & validate"
          view-model.ref="addressInput"></pinput-text>
      </pform-input>
      <div class="detailsTable" if.bind="showTokenDetails">
        <div class="detailsCell">
          <p>Name</p>
          <p if.bind="!tokenDetailsNotFound.name">${token.name}</p>
          <pinput-text if.bind="tokenDetailsNotFound.name" value.bind="token.name"></pinput-text>
        </div>
        <div class="detailsCell">

          <p>Symbol</p>
          <p if.bind="!tokenDetailsNotFound.symbol">${token.symbol}</p>
          <pinput-text if.bind="tokenDetailsNotFound.symbol" value.bind="token.symbol"></pinput-text>
        </div>
        <div class="detailsCell">
          <p>Decimals</p>
          <p if.bind="!tokenDetailsNotFound.decimals">${token.decimals}</p>
          <pinput-numeric if.bind="tokenDetailsNotFound.decimals" not-wei value.bind="token.decimals"></pinput-numeric>
        </div>
        <div class="detailsCell">
          <p>
            Logo
            <img error.trigger="logoLoaded(false)" height="19" if.bind="validTokenLogoURI"
              load.trigger="logoLoaded(true)"
              src.bind="token.logoURI">
          </p>
          <pform-input input-reference.bind="logoImageInput">
            <pinput-text input.trigger="checkURL()" value.bind="token.logoURI & validate"
              view-model.ref="logoImageInput"></pinput-text>
          </pform-input>
        </div>
      </div>
      <pform-input data-test="proposal-token-amount-field"
        input-reference.bind="amountInput"
        label="Total Amount of Tokens to Swap"
        label-description="This defines the total amount of token that will be transferred to the other DAO during the swap. You can adjust this amount at any time before the on-chain execution phase of the deal.">
        <pinput-numeric
          placeholder="500.000"
          value.bind="token.amount & validate"
          decimals.bind="token.decimals"
          view-model.ref="amountInput"></pinput-numeric>
      </pform-input>
      <pform-input
        label="Instant Transfer Set-up"
        label-description="Once the deal is executed on-chain, the Instant Transfer amount will be immediately sent to the other DAOâ€™s treasury address. You can adjust how much of the total amount is set to be transferred instantly and how much will be vested (see below).">
        <prange-slider
          hide-Percentage
          left-label.bind="'Instant ('+ rangeSlider.leftPercentage + '%)'"
          disabled.bind="!token.amount"
          right-label.bind="'Vested ('+ rangeSlider.rightPercentage + '%)'"
          left.bind="token.instantTransferAmount | ethwei & validate"
          view-model.ref="rangeSlider"
          max-value.bind="token.amount | ethwei"
          not-wei
          right.bind="token.vestedTransferAmount | ethwei & validate"></prange-slider>
      </pform-input>

      <pform-input label="Vesting Set-up"
        label-description="Decide how long the tokens should be vested for, and the cliff period which defines the days after which the tokens can be claimed.">
        <div class="vesting">
          <div class="vesting-input">
            <p>Tokens vested for</p>
            <pform-input data-test="proposal-vested-period-field" input-reference.bind="vestedForInput">
              <pinput-group disabled.bind="token.amount.toString() === token.instantTransferAmount.toString()">
                <pinput-numeric
                  disabled.bind="token.amount.toString() === token.instantTransferAmount.toString()"
                  not-wei
                  value.bind="token.vestedFor | secondsDays & validate"
                  view-model.ref="vestedForInput"></pinput-numeric>
                <span slot="after">days</span>
              </pinput-group>
            </pform-input>
          </div>
          <div class="vesting-input">
            <p>with a cliff of</p>
            <pform-input data-test="proposal-cliff-period-field" input-reference.bind="cliffOfInput">
              <pinput-group disabled.bind="token.amount.toString() === token.instantTransferAmount.toString()">
                <pinput-numeric
                  disabled.bind="token.amount.toString() === token.instantTransferAmount.toString()"
                  not-wei
                  value.bind="token.cliffOf | secondsDays & validate"
                  view-model.ref="cliffOfInput"></pinput-numeric>
                <span slot="after">days</span>
              </pinput-group>
            </pform-input>
          </div>
        </div>
      </pform-input>

      <div class="tokenDetailsFooter">
        <pbutton if.bind="!hideDeleteButton" class="deleteButton" click.delegate="onDelete()" type="tertiary">
          Delete
          <i class="fa fa-trash"></i>
        </pbutton>
        <pbutton click.delegate="save()" is-loading.bind="saving" type="primary">Save</pbutton>
      </div>
    </div>

    <div class="tokenDetailsView" if.bind="viewMode === 'view'">
      <p class="tokenName">
        <img error.trigger="token.logoURI = ''" height="32" if.bind="token.logoURI" src.bind="token.logoURI">
        ${token.name || '-'}
      </p>
      <div class="detailsTable detailsTableInViewMode">
        <div class="detailsCell">
          <p>Token address</p>
          <p if.bind="token.address">
            <etherscanlink
              text="${token.address | smallHexString}"
              address.bind="token.address">
            </etherscanlink>
          </p>
          <p else>-</p>
        </div>

        <div class="detailsCell detailsCellAmount">
          <p>Total Amount of Tokens to Swap</p>
          <p>
            <formatted-number if.bind="token.amount >= 0" thousands-separated
              value.to-view="token.amount | ethwei"></formatted-number>
            <template else>
              -
            </template>
          </p>
        </div>

        <div class="detailsCell">
          <p>Instant transfer</p>
          <p>
            <formatted-number if.bind="token.instantTransferAmount" thousands-separated
              value.to-view="token.instantTransferAmount | ethwei"></formatted-number>
            <template else>
              -
            </template>
          </p>
        </div>

        <div class="detailsCell">
          <p>Vested transfer</p>
          <p>
            <formatted-number if.bind="token.vestedTransferAmount" thousands-separated
              value.to-view="token.vestedTransferAmount | ethwei"></formatted-number>
            <template else>
              -
            </template>
          </p>
        </div>

        <div class="detailsCell" ptooltip.bind="withCommas(token.vestedFor) + ' seconds'">
          <p>Vested for</p>
          <p>
            <formatted-number hide-tooltip if.bind="token.vestedFor"
              value.to-view="token.vestedFor | secondsDays | number"></formatted-number>
            <template else>0</template>
            days
          </p>
        </div>

        <div class="detailsCell" ptooltip.bind="withCommas(token.cliffOf) + ' seconds'">
          <p>Cliff of</p>
          <formatted-number hide-tooltip if.bind="token.cliffOf"
            value.to-view="token.cliffOf | secondsDays | number"></formatted-number>
          <template else>0</template>
          days
        </div>
      </div>

      <div class="tokenDetailsFooter">
        <p class="feedbackMessage ${!valid ? 'feedbackMessageVisible' : ''} errorMessage">
          Token details has invalid information. Please edit them.
        </p>
        <pbutton click.delegate="viewMode = 'edit'" type="tertiary">Edit</pbutton>
      </div>
    </div>
  </pcard>

</template>
